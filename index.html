<!DOCTYPE html>
<html>
<head>
  <title>Lolscord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { margin:0; font-family: Arial; background:#313338; color:white; }
    .center { display:flex; justify-content:center; align-items:center; height:100vh; }
    .box { background:#2b2d31; padding:30px; border-radius:8px; width:300px; }
    input { width:100%; padding:8px; margin:6px 0; }
    button { width:100%; padding:8px; margin-top:10px; background:#5865f2; border:none; color:white; cursor:pointer; }
    #chat { display:none; height:100vh; flex-direction:column; }
    #messages { flex:1; overflow-y:auto; padding:20px; }
    .message { margin-bottom:10px; }
    .input-area { display:flex; padding:10px; background:#383a40; }
    .input-area input { flex:1; }
  </style>
</head>
<body>

<div id="auth" class="center">
  <div class="box">
    <h2 id="authTitle">Login</h2>
    <input id="username" placeholder="Username (register only)" style="display:none"/>
    <input id="email" placeholder="Email"/>
    <input id="password" type="password" placeholder="Password"/>
    <input id="confirmPassword" type="password" placeholder="Confirm Password" style="display:none"/>
    <button onclick="handleAuth()">Submit</button>
    <p onclick="toggleMode()" style="cursor:pointer; margin-top:10px;" id="toggleText">Don't have an account? Register</p>
  </div>
</div>

<div id="chat">
  <div style="padding:10px; background:#2b2d31;">
    Logged in as <span id="loggedUser"></span>
    <button onclick="logout()" style="float:right;">Logout</button>
  </div>
  <div id="messages"></div>
  <div class="input-area">
    <input id="messageInput" placeholder="Type message..."/>
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
let mode = "login";
let socket;
const backend = "https://lolscord-backend-8ghq.onrender.com";

function toggleMode() {
  mode = mode === "login" ? "register" : "login";
  document.getElementById("authTitle").innerText = mode === "login" ? "Login" : "Register";
  document.getElementById("username").style.display = mode === "register" ? "block" : "none";
  document.getElementById("confirmPassword").style.display = mode === "register" ? "block" : "none";
  document.getElementById("toggleText").innerText =
    mode === "login" ? "Don't have an account? Register" : "Already have an account? Login";
}

async function handleAuth() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  if (mode === "register") {
    const username = document.getElementById("username").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    const res = await fetch(backend + "/register", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username, email, password, confirmPassword })
    });

    const data = await res.json();
    alert(data.message);
  } else {
    const res = await fetch(backend + "/login", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (data.token) {
      localStorage.setItem("token", data.token);
      localStorage.setItem("username", data.username);
      startChat(data.username);
    } else {
      alert(data.message);
    }
  }
}

function startChat(username) {
  document.getElementById("auth").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  document.getElementById("loggedUser").innerText = username;

  socket = io(backend);

  socket.on("load messages", (messages) => {
    document.getElementById("messages").innerHTML = "";
    messages.forEach(msg => addMessage(msg));
  });

  socket.on("chat message", (msg) => {
    addMessage(msg);
  });
}

function sendMessage() {
  const msg = document.getElementById("messageInput").value;
  if (!msg) return;

  socket.emit("chat message", {
    username: localStorage.getItem("username"),
    message: msg
  });

  document.getElementById("messageInput").value = "";
}

function addMessage(msg) {
  const div = document.createElement("div");
  div.className = "message";
  div.innerText = msg.username + ": " + msg.message;
  document.getElementById("messages").appendChild(div);
}

function logout() {
  localStorage.clear();
  location.reload();
}

// Auto login
if (localStorage.getItem("token")) {
  startChat(localStorage.getItem("username"));
}
</script>

</body>
</html>
